name: Security - Process & Forward Reports

on:
  workflow_run:
    workflows:
      - 'üîí Security - SAST (Static Analysis)'
      - 'üì¶ Security - SCA (Dependencies)'
      - 'üõ°Ô∏è Security - CVE & NVD Database Scan'
      - 'üê≥ Security - Container Scanning'
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  process-and-forward:
    name: Process artifacts and forward to SIEM/SOAR
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Download all security artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./security-artifacts
        continue-on-error: true

      - name: Install requirements for processing
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install requests || true

      - name: Run triage (generate triage-report.json)
        run: |
          python scripts/triage_vulnerabilities.py || true

      - name: Generate consolidated report (security-report.json/html)
        run: |
          python scripts/generate_report.py || true

      - name: Forward reports to SIEM/SOAR and notify Slack
        env:
          SIEM_URL: ${{ secrets.SIEM_URL }}
          SIEM_API_KEY: ${{ secrets.SIEM_API_KEY }}
          THEHIVE_URL: ${{ secrets.THEHIVE_URL }}
          THEHIVE_API_KEY: ${{ secrets.THEHIVE_API_KEY }}
          MISP_URL: ${{ secrets.MISP_URL }}
          MISP_API_KEY: ${{ secrets.MISP_API_KEY }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          # Forward main consolidated report if present
          if [ -f security-report.json ]; then
            python scripts/forward_to_siem.py --report security-report.json || echo "Forward failed"
          fi

          # Also forward triage report if present
          if [ -f triage-report.json ]; then
            python scripts/forward_to_siem.py --report triage-report.json || echo "Forward failed"
          fi

      - name: Upload processed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-processed
          path: |
            security-report.json
            security-report.html
            triage-report.json
        continue-on-error: true
