name: ğŸ“Š Security - Consolidated Report

on:
  workflow_run:
    workflows:
      - 'ğŸ”’ Security - SAST (Static Analysis)'
      - 'ğŸ“¦ Security - SCA (Dependencies)'
      - 'ğŸ›¡ï¸ Security - CVE & NVD Database Scan'
      - 'ğŸ³ Security - Container Scanning'
      - 'ğŸ¤– AI - Model Integrity & Tests'
      - 'âœ… Tests & Code Quality'
    types: [completed]

permissions:
  contents: read
  checks: write

jobs:
  report:
    name: Generate Security Summary
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts
        continue-on-error: true

      - name: Generate summary
        run: |
          python3 << 'EOF'
          import json
          import os
          from datetime import datetime
          
          summary = {
              "timestamp": datetime.now().isoformat(),
              "scans": {
                  "sast": "completed",
                  "sca": "completed",
                  "cve_nvd": "completed",
                  "container": "completed",
                  "ai_model": "completed",
                  "tests": "completed"
              },
              "artifacts_available": []
          }
          
          for root, dirs, files in os.walk("./all-artifacts"):
              for file in files:
                  if file.endswith(('.json', '.sarif', '.xml')):
                      summary["artifacts_available"].append(file)
          
          with open("security-report.json", "w") as f:
              json.dump(summary, f, indent=2)
          
          print("âœ… Report generated")
          EOF

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-final
          path: security-report.json
          retention-days: 90

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ”’ Security Assessment Complete
          
          ## âœ… All Scans Completed
          - âœ… SAST (Bandit, Semgrep, Pylint)
          - âœ… SCA (Safety, pip-audit)
          - âœ… CVE/NVD Database
          - âœ… Container Scanning (Trivy)
          - âœ… AI Model Validation
          - âœ… Tests & Quality
          
          ## ğŸ“Š Reports Location
          All reports available in **Artifacts** tab
          EOF
